<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé± Singapore TOTO Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #F4B942;
            --gold-light: #FFD873;
            --gold-dark: #C9922E;
            --bg-primary: #0D1117;
            --bg-secondary: #161B22;
            --bg-tertiary: #21262D;
            --text-primary: #F0F6FC;
            --text-secondary: #8B949E;
            --accent-blue: #58A6FF;
            --accent-green: #3FB950;
            --accent-red: #F85149;
            --border: #30363D;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(244, 185, 66, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(88, 166, 255, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-radius: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--gold), var(--gold-light), var(--gold));
        }

        .logo {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 50%, var(--gold) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .admin-link {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .admin-link:hover {
            color: var(--gold);
            border-color: var(--gold);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--gold);
            box-shadow: 0 10px 40px rgba(244, 185, 66, 0.1);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
        }

        /* Recommended Numbers Section */
        .recommendations {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .recommendations::before {
            content: '‚≠ê RECOMMENDED';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gold);
            color: var(--bg-primary);
            padding: 0.25rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .rec-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .rec-grid {
                grid-template-columns: 1fr;
            }
        }

        .rec-section h3 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .number-balls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .ball {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .ball-main {
            background: linear-gradient(145deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--bg-primary);
            box-shadow: 0 4px 15px rgba(244, 185, 66, 0.3);
        }

        .ball-additional {
            background: linear-gradient(145deg, var(--accent-blue) 0%, #2D5FA8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(88, 166, 255, 0.3);
        }

        .ball:hover {
            transform: scale(1.15) rotate(5deg);
        }

        /* Probability Tables */
        .prob-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .prob-section h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .prob-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
        }

        .prob-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.75rem 0.5rem;
            text-align: center;
            transition: all 0.2s ease;
        }

        .prob-item:hover {
            border-color: var(--gold);
            background: var(--bg-primary);
        }

        .prob-number {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .prob-percent {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .prob-bar {
            height: 3px;
            background: var(--bg-primary);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .prob-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-light));
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* Recent Draws */
        .recent-draws {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .recent-draws h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .draws-table {
            width: 100%;
            border-collapse: collapse;
        }

        .draws-table th,
        .draws-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .draws-table th {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .draws-table tr:hover td {
            background: var(--bg-tertiary);
        }

        .draw-numbers {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .mini-ball {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Space Mono', monospace;
            font-weight: 600;
            font-size: 0.8rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
        }

        .mini-ball.additional {
            background: var(--accent-blue);
            color: white;
            border: none;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 4rem;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Algorithm Info */
        .algorithm-info {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .algorithm-info h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--gold);
        }

        .algorithm-info code {
            font-family: 'Space Mono', monospace;
            background: var(--bg-primary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            display: block;
            margin: 0.5rem 0;
            color: var(--accent-green);
        }

        .algorithm-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .ball {
                width: 42px;
                height: 42px;
                font-size: 0.95rem;
            }

            .prob-grid {
                grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
            }
        }

        /* No Data State */
        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .no-data-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Sync Status */
        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="admin.html" class="admin-link">üîê Admin</a>
            <div class="logo">üé±</div>
            <h1>Singapore TOTO Calculator</h1>
            <p class="subtitle">Historical probability analysis based on past draws</p>
            <div class="sync-status">
                <span class="sync-dot"></span>
                <span>Cloud Synced ‚Ä¢ Read-Only View</span>
            </div>
        </header>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading lottery data...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-label">Storage Period</div>
                    <div class="stat-value" id="storagePeriod">3 Years</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">#Ô∏è‚É£</div>
                    <div class="stat-label">Total Draws</div>
                    <div class="stat-value" id="totalDraws">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÜ</div>
                    <div class="stat-label">Data Range</div>
                    <div class="stat-value" id="dataRange">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üîÑ</div>
                    <div class="stat-label">Last Updated</div>
                    <div class="stat-value" id="lastUpdated">-</div>
                </div>
            </div>

            <!-- Recommended Numbers -->
            <div class="recommendations">
                <div class="rec-grid">
                    <div class="rec-section">
                        <h3>üéØ Top 6 Main Numbers (Highest Probability)</h3>
                        <div class="number-balls" id="topMainNumbers">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="rec-section">
                        <h3>‚ûï Top Additional Number</h3>
                        <div class="number-balls" id="topAdditionalNumber">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Numbers Probability -->
            <div class="prob-section">
                <h2>üìä All Main Numbers Probability (1-49)</h2>
                <div class="prob-grid" id="mainProbGrid">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Additional Numbers Probability -->
            <div class="prob-section">
                <h2>üíØ All Additional Numbers Probability (1-49)</h2>
                <div class="prob-grid" id="additionalProbGrid">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Recent Draws -->
            <div class="recent-draws">
                <h2>üèÜ Recent Draws</h2>
                <div style="overflow-x: auto;">
                    <table class="draws-table">
                        <thead>
                            <tr>
                                <th>Draw #</th>
                                <th>Date</th>
                                <th>Main Numbers</th>
                                <th>Additional</th>
                            </tr>
                        </thead>
                        <tbody id="recentDrawsBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Algorithm Info -->
            <div class="algorithm-info">
                <h3>üìê Algorithm</h3>
                <code>Probability = ((Number of occurrences / Total draws) + 0.01) √ó 100%</code>
                <p>Maximum 3 years of data stored. Data is synced across all devices via cloud storage.</p>
            </div>
        </div>

        <div id="noData" class="no-data" style="display: none;">
            <div class="no-data-icon">üì≠</div>
            <h2>No Data Available</h2>
            <p>No lottery draws have been added yet. Please ask the administrator to add data.</p>
        </div>

        <footer>
            <p>Singapore TOTO Lottery Probability Calculator ‚Ä¢ Data synced via cloud</p>
            <p style="margin-top: 0.5rem; opacity: 0.7;">For entertainment purposes only. Lottery outcomes are random.</p>
        </footer>
    </div>

    <script>
        // JSONBin Configuration
        const JSONBIN_API_KEY = '$2a$10$R/mm5ZKrBGZrNUbiKNeNDeYN9mngd2TZHfmRauxTxXf/MHqsbfNnW';
        const JSONBIN_BIN_ID = localStorage.getItem('toto_bin_id') || null;
        
        let lotteryData = {
            draws: [],
            lastUpdated: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
        });

        // Load data from JSONBin
        async function loadData() {
            const loading = document.getElementById('loading');
            const content = document.getElementById('content');
            const noData = document.getElementById('noData');

            try {
                // First, try to get bin ID from a known location or create discovery
                let binId = await discoverBinId();
                
                if (!binId) {
                    loading.style.display = 'none';
                    noData.style.display = 'block';
                    return;
                }

                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: {
                        'X-Access-Key': JSONBIN_API_KEY
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    lotteryData = result.record || { draws: [], lastUpdated: null };
                    
                    // Store bin ID for future use
                    localStorage.setItem('toto_bin_id', binId);
                    
                    if (lotteryData.draws && lotteryData.draws.length > 0) {
                        loading.style.display = 'none';
                        content.style.display = 'block';
                        renderData();
                    } else {
                        loading.style.display = 'none';
                        noData.style.display = 'block';
                    }
                } else {
                    throw new Error('Failed to load data');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                loading.style.display = 'none';
                noData.style.display = 'block';
            }
        }

        // Discover bin ID - check for master config bin
        async function discoverBinId() {
            // Check localStorage first
            const storedBinId = localStorage.getItem('toto_bin_id');
            if (storedBinId) {
                return storedBinId;
            }

            // Try to fetch from a config bin (you'll set this up in admin)
            // For now, we'll use the collection approach
            try {
                const response = await fetch('https://api.jsonbin.io/v3/c/uncategorized/bins', {
                    headers: {
                        'X-Access-Key': JSONBIN_API_KEY
                    }
                });

                if (response.ok) {
                    const bins = await response.json();
                    // Look for our TOTO bin
                    for (const bin of bins) {
                        if (bin.snippetMeta && bin.snippetMeta.name === 'TOTO_LOTTERY_DATA') {
                            return bin.record;
                        }
                    }
                }
            } catch (e) {
                console.log('Could not discover bin from collection');
            }

            return null;
        }

        // Render all data
        function renderData() {
            renderStats();
            renderRecommendations();
            renderProbabilityGrids();
            renderRecentDraws();
        }

        // Calculate probabilities
        function calculateProbabilities() {
            const mainCounts = {};
            const additionalCounts = {};
            
            for (let i = 1; i <= 49; i++) {
                mainCounts[i] = 0;
                additionalCounts[i] = 0;
            }

            const draws = lotteryData.draws || [];
            
            draws.forEach(draw => {
                draw.mainNumbers.forEach(num => {
                    mainCounts[num]++;
                });
                additionalCounts[draw.additionalNumber]++;
            });

            const totalDraws = draws.length;
            const mainProbs = {};
            const additionalProbs = {};

            for (let i = 1; i <= 49; i++) {
                mainProbs[i] = totalDraws > 0 
                    ? ((mainCounts[i] / totalDraws) + 0.01) * 100 
                    : 1;
                additionalProbs[i] = totalDraws > 0 
                    ? ((additionalCounts[i] / totalDraws) + 0.01) * 100 
                    : 1;
            }

            return { mainProbs, additionalProbs, mainCounts, additionalCounts, totalDraws };
        }

        // Render stats
        function renderStats() {
            const draws = lotteryData.draws || [];
            
            document.getElementById('totalDraws').textContent = draws.length;
            
            if (draws.length > 0) {
                const sortedDraws = [...draws].sort((a, b) => new Date(a.date) - new Date(b.date));
                const firstDate = new Date(sortedDraws[0].date);
                const lastDate = new Date(sortedDraws[sortedDraws.length - 1].date);
                
                document.getElementById('dataRange').textContent = 
                    `${sortedDraws[0].drawNumber} - ${sortedDraws[sortedDraws.length - 1].drawNumber}`;
            }

            if (lotteryData.lastUpdated) {
                const updateDate = new Date(lotteryData.lastUpdated);
                document.getElementById('lastUpdated').textContent = 
                    updateDate.toLocaleDateString('en-SG', { day: 'numeric', month: 'short' });
            }
        }

        // Render recommendations
        function renderRecommendations() {
            const { mainProbs, additionalProbs } = calculateProbabilities();
            
            // Sort and get top 6 main numbers
            const sortedMain = Object.entries(mainProbs)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            
            // Get top additional number
            const sortedAdditional = Object.entries(additionalProbs)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 1);

            const topMainContainer = document.getElementById('topMainNumbers');
            topMainContainer.innerHTML = sortedMain
                .map(([num, prob]) => `<div class="ball ball-main">${num}</div>`)
                .join('');

            const topAdditionalContainer = document.getElementById('topAdditionalNumber');
            topAdditionalContainer.innerHTML = sortedAdditional
                .map(([num, prob]) => `<div class="ball ball-additional">${num}</div>`)
                .join('');
        }

        // Render probability grids
        function renderProbabilityGrids() {
            const { mainProbs, additionalProbs } = calculateProbabilities();
            const maxMainProb = Math.max(...Object.values(mainProbs));
            const maxAdditionalProb = Math.max(...Object.values(additionalProbs));

            const mainGrid = document.getElementById('mainProbGrid');
            mainGrid.innerHTML = '';
            
            for (let i = 1; i <= 49; i++) {
                const prob = mainProbs[i];
                const barWidth = (prob / maxMainProb) * 100;
                
                mainGrid.innerHTML += `
                    <div class="prob-item">
                        <div class="prob-number">${i}</div>
                        <div class="prob-percent">${prob.toFixed(1)}%</div>
                        <div class="prob-bar">
                            <div class="prob-bar-fill" style="width: ${barWidth}%"></div>
                        </div>
                    </div>
                `;
            }

            const additionalGrid = document.getElementById('additionalProbGrid');
            additionalGrid.innerHTML = '';
            
            for (let i = 1; i <= 49; i++) {
                const prob = additionalProbs[i];
                const barWidth = (prob / maxAdditionalProb) * 100;
                
                additionalGrid.innerHTML += `
                    <div class="prob-item">
                        <div class="prob-number">${i}</div>
                        <div class="prob-percent">${prob.toFixed(1)}%</div>
                        <div class="prob-bar">
                            <div class="prob-bar-fill" style="width: ${barWidth}%"></div>
                        </div>
                    </div>
                `;
            }
        }

        // Render recent draws
        function renderRecentDraws() {
            const draws = lotteryData.draws || [];
            const sortedDraws = [...draws]
                .sort((a, b) => b.drawNumber - a.drawNumber)
                .slice(0, 10);

            const tbody = document.getElementById('recentDrawsBody');
            tbody.innerHTML = sortedDraws.map(draw => `
                <tr>
                    <td><strong>#${draw.drawNumber}</strong></td>
                    <td>${new Date(draw.date).toLocaleDateString('en-SG', { 
                        day: 'numeric', 
                        month: 'short', 
                        year: 'numeric' 
                    })}</td>
                    <td>
                        <div class="draw-numbers">
                            ${draw.mainNumbers.map(n => `<span class="mini-ball">${n}</span>`).join('')}
                        </div>
                    </td>
                    <td>
                        <span class="mini-ball additional">${draw.additionalNumber}</span>
                    </td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
