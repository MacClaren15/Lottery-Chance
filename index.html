<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Singapore TOTO Lottery Probability Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Loading State -->
        <div id="loading" class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading data...</p>
            </div>
        </div>

        <!-- Main Content (hidden initially) -->
        <div id="mainContent" style="display: none;">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-5xl font-bold text-gray-800 mb-3">üé± Singapore TOTO Calculator</h1>
                <p class="text-gray-600">Historical probability analysis based on past draws</p>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3 mb-6 justify-center">
                <button onclick="showAddForm()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all flex items-center gap-2">
                    <span>‚ûï</span> Add New Draw
                </button>
                <button onclick="showFilterForm()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all flex items-center gap-2">
                    <span>üîç</span> Filter Data
                </button>
                <button onclick="showImportForm()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all flex items-center gap-2">
                    <span>üì§</span> Import CSV
                </button>
                <button onclick="exportData()" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all flex items-center gap-2">
                    <span>üíæ</span> Export CSV
                </button>
                <button onclick="refreshData()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all flex items-center gap-2">
                    <span>üîÑ</span> Refresh
                </button>
            </div>

            <!-- Add Draw Modal -->
            <div id="addDrawModal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Add New Draw</h2>
                    <form onsubmit="handleAddDraw(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Draw Number</label>
                                <input type="text" id="newDrawNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 4128">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                                <input type="date" id="newDrawDate" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Main Numbers (1-49)</label>
                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <input type="number" id="newNumber1" min="1" max="49" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="#1">
                                <input type="number" id="newNumber2" min="1" max="49" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="#2">
                                <input type="number" id="newNumber3" min="1" max="49" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="#3">
                                <input type="number" id="newNumber4" min="1" max="49" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="#4">
                                <input type="number" id="newNumber5" min="1" max="49" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="#5">
                                <input type="number" id="newNumber6" min="1" max="49" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="#6">
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Additional Number (1-49)</label>
                            <input type="number" id="newAdditional" min="1" max="49" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Additional">
                        </div>
                        <div id="addDrawError" class="text-red-600 mb-4" style="display: none;"></div>
                        <div class="flex gap-4">
                            <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-4 rounded-xl transition-all">Add Draw</button>
                            <button type="button" onclick="hideAddForm()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-4 rounded-xl transition-all">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Filter Modal -->
            <div id="filterModal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-2xl shadow-2xl max-w-xl w-full p-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Filter Data Range</h2>
                    <div class="space-y-6 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">From Draw Number</label>
                            <input type="text" id="filterFromDraw" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 4000">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">To Draw Number</label>
                            <input type="text" id="filterToDraw" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 4128">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Last N Months</label>
                            <select id="filterMonths" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">All available data</option>
                                <option value="12">Last 12 months</option>
                                <option value="24">Last 24 months</option>
                                <option value="36" selected>Last 36 months</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="applyFilters()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 rounded-xl transition-all">Apply Filters</button>
                        <button onclick="resetFilters()" class="px-8 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-4 rounded-xl transition-all">Reset</button>
                    </div>
                </div>
            </div>

            <!-- Import Modal -->
            <div id="importModal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-2xl shadow-2xl max-w-xl w-full p-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Import CSV Data</h2>
                    <div class="mb-6">
                        <p class="text-gray-600 mb-4">Upload a CSV file with lottery draw data. First download the template to see the required format.</p>
                        <button onclick="downloadTemplate()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 rounded-xl transition-all mb-4">üì• Download Template</button>
                        <input type="file" id="importFileInput" accept=".csv" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div id="importStatus" class="text-sm mb-4" style="display: none;"></div>
                    <div class="flex gap-4">
                        <button onclick="handleFileImport()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-4 rounded-xl transition-all">Import</button>
                        <button onclick="hideImportForm()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-4 rounded-xl transition-all">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="bg-purple-100 p-3 rounded-lg">
                            <span class="text-2xl">üìÖ</span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Storage Period</p>
                            <p id="storagePeriod" class="text-sm font-semibold text-gray-800">3 Years (0 draws)</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="bg-pink-100 p-3 rounded-lg">
                            <span class="text-2xl">#Ô∏è‚É£</span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Active Data Range</p>
                            <p id="dateRange" class="text-xs font-semibold text-gray-800">No data</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommended Numbers -->
            <div class="bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl shadow-2xl p-8 mb-8 text-white">
                <div class="flex items-center gap-3 mb-6">
                    <span class="text-3xl">üèÜ</span>
                    <h2 class="text-3xl font-bold">Recommended Numbers (Highest Probability)</h2>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                            <span>‚≠ê</span> Top 6 Main Numbers
                        </h3>
                        <div id="topMainNumbers" class="grid grid-cols-3 gap-3"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                            <span>‚≠ê</span> Top Additional Number
                        </h3>
                        <div id="topAdditional"></div>
                    </div>
                </div>
            </div>

            <!-- All Main Numbers -->
            <div class="bg-white rounded-2xl shadow-lg p-8 mb-8 border border-gray-100">
                <div class="flex items-center gap-3 mb-6">
                    <span class="text-3xl">üìä</span>
                    <h2 class="text-2xl font-bold text-gray-800">All Main Numbers Probability (1-49)</h2>
                </div>
                <div id="allMainNumbers" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-3"></div>
            </div>

            <!-- All Additional Numbers -->
            <div class="bg-white rounded-2xl shadow-lg p-8 mb-8 border border-gray-100">
                <div class="flex items-center gap-3 mb-6">
                    <span class="text-3xl">üíØ</span>
                    <h2 class="text-2xl font-bold text-gray-800">All Additional Numbers Probability (1-49)</h2>
                </div>
                <div id="allAdditionalNumbers" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-3"></div>
            </div>

            <!-- Algorithm Info -->
            <div class="mt-8 bg-indigo-50 rounded-xl p-6 border border-indigo-200">
                <h3 class="text-lg font-semibold text-indigo-900 mb-2">Algorithm</h3>
                <p class="text-indigo-700">Probability = ((Number of occurrences / Total draws) + 0.01) √ó 100%</p>
                <p class="text-sm text-indigo-600 mt-2">Maximum 3 years of data stored. Use filters to analyze specific time periods or draw ranges.</p>
                <p id="analysisInfo" class="text-xs text-indigo-500 mt-1"></p>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let historicalData = [];
        let filteredData = [];
        let filterSettings = { fromDraw: '', toDraw: '', months: '36' };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });

        function formatDateForDisplay(dateString) {
            const date = new Date(dateString);
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('en-GB', options);
        }

        async function loadData() {
            try {
                const stored = localStorage.getItem('lottery-historical-data');
                if (stored) {
                    const data = JSON.parse(stored);
                    historicalData = data.draws || [];
                } else {
                    await initializeDefaultData();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                await initializeDefaultData();
            }
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            applyFilters();
        }

        async function initializeDefaultData() {
            historicalData = [
                { drawNumber: '4127', date: '2025-11-03', numbers: [10, 19, 22, 34, 39, 43], additional: 35 },
                { drawNumber: '4126', date: '2025-10-30', numbers: [1, 5, 31, 34, 38, 45], additional: 15 },
                { drawNumber: '4125', date: '2025-10-27', numbers: [9, 17, 22, 24, 31, 38], additional: 47 }
            ];
            await saveData();
        }

        async function saveData() {
            const data = {
                draws: historicalData,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('lottery-historical-data', JSON.stringify(data));
        }

        function applyFilters() {
            let filtered = [...historicalData];

            // Apply draw number filters
            if (filterSettings.fromDraw) {
                filtered = filtered.filter(d => parseInt(d.drawNumber) >= parseInt(filterSettings.fromDraw));
            }
            if (filterSettings.toDraw) {
                filtered = filtered.filter(d => parseInt(d.drawNumber) <= parseInt(filterSettings.toDraw));
            }

            // Apply month filter
            if (filterSettings.months) {
                const monthsAgo = new Date();
                monthsAgo.setMonth(monthsAgo.getMonth() - parseInt(filterSettings.months));
                filtered = filtered.filter(d => new Date(d.date) >= monthsAgo);
            }

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            filteredData = filtered;
            
            updateUI();
            hideFilterForm();
        }

        function resetFilters() {
            filterSettings = { fromDraw: '', toDraw: '', months: '36' };
            document.getElementById('filterFromDraw').value = '';
            document.getElementById('filterToDraw').value = '';
            document.getElementById('filterMonths').value = '36';
            applyFilters();
        }

        function calculateProbabilities() {
            if (filteredData.length === 0) return { numberStats: [], additionalStats: [] };

            const mainCounts = {};
            const additionalCounts = {};

            // Count occurrences
            for (let i = 1; i <= 49; i++) {
                mainCounts[i] = 0;
                additionalCounts[i] = 0;
            }

            filteredData.forEach(draw => {
                draw.numbers.forEach(num => mainCounts[num]++);
                additionalCounts[draw.additional]++;
            });

            // Calculate probabilities
            const totalDraws = filteredData.length;
            const numberStats = Object.keys(mainCounts).map(num => ({
                number: parseInt(num),
                count: mainCounts[num],
                probability: ((mainCounts[num] / totalDraws) + 0.01) * 100
            })).sort((a, b) => b.probability - a.probability);

            const additionalStats = Object.keys(additionalCounts).map(num => ({
                number: parseInt(num),
                count: additionalCounts[num],
                probability: ((additionalCounts[num] / totalDraws) + 0.01) * 100
            })).sort((a, b) => b.probability - a.probability);

            return { numberStats, additionalStats };
        }

        function updateUI() {
            const { numberStats, additionalStats } = calculateProbabilities();
            
            // Update stats cards
            document.getElementById('storagePeriod').textContent = `3 Years (${historicalData.length} draws)`;
            
            if (filteredData.length > 0) {
                const firstDate = formatDateForDisplay(filteredData[filteredData.length - 1].date);
                const lastDate = formatDateForDisplay(filteredData[0].date);
                document.getElementById('dateRange').textContent = `${filteredData.length} draws: ${firstDate} - ${lastDate}`;
                document.getElementById('analysisInfo').textContent = 
                    `Currently analyzing ${filteredData.length} draws from ${filteredData[filteredData.length - 1].drawNumber} to ${filteredData[0].drawNumber}`;
            } else {
                document.getElementById('dateRange').textContent = 'No data in selected range';
                document.getElementById('analysisInfo').textContent = 'No data to analyze';
            }

            // Top 6 main numbers
            const topMain = numberStats.slice(0, 6);
            const topMainHTML = topMain.map(stat => `
                <div class="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-4 text-center border border-white border-opacity-30">
                    <div class="text-4xl font-bold text-yellow-300 mb-2">${stat.number.toString().padStart(2, '0')}</div>
                    <div class="text-sm opacity-90">${stat.probability.toFixed(2)}%</div>
                    <div class="text-xs opacity-75 mt-1">(${stat.count} times)</div>
                </div>
            `).join('');
            document.getElementById('topMainNumbers').innerHTML = topMainHTML;

            // Top additional
            const topAdd = additionalStats[0];
            if (topAdd) {
                document.getElementById('topAdditional').innerHTML = `
                    <div class="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-6 text-center border border-white border-opacity-30 max-w-xs">
                        <div class="text-6xl font-bold text-orange-300 mb-3">${topAdd.number.toString().padStart(2, '0')}</div>
                        <div class="text-xl font-semibold">${topAdd.probability.toFixed(2)}%</div>
                        <div class="text-sm opacity-75 mt-2">Appeared ${topAdd.count} times</div>
                    </div>
                `;
            }

            // All main numbers
            const topMainNumbers = new Set(topMain.map(s => s.number));
            const allMainHTML = numberStats.map(stat => {
                const isTop = topMainNumbers.has(stat.number);
                return `
                    <div class="rounded-lg p-3 border-2 ${isTop ? 'bg-gradient-to-br from-indigo-50 to-purple-50 border-indigo-400' : 'bg-gray-50 border-gray-200'}">
                        <div class="text-center">
                            <div class="text-2xl font-bold mb-1 ${isTop ? 'text-indigo-600' : 'text-gray-700'}">
                                ${stat.number.toString().padStart(2, '0')}
                            </div>
                            <div class="text-xs font-semibold text-gray-600">${stat.probability.toFixed(2)}%</div>
                            <div class="text-xs text-gray-500 mt-1">${stat.count}x</div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                                <div class="h-1.5 rounded-full ${isTop ? 'bg-gradient-to-r from-indigo-500 to-purple-500' : 'bg-gray-400'}" 
                                     style="width: ${Math.min(100, stat.probability)}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('allMainNumbers').innerHTML = allMainHTML;

            // All additional numbers
            const allAddHTML = additionalStats.map(stat => {
                const isTop = topAdd && topAdd.number === stat.number;
                return `
                    <div class="rounded-lg p-3 border-2 ${isTop ? 'bg-gradient-to-br from-orange-50 to-red-50 border-orange-400' : 'bg-gray-50 border-gray-200'}">
                        <div class="text-center">
                            <div class="text-2xl font-bold mb-1 ${isTop ? 'text-orange-600' : 'text-gray-700'}">
                                ${stat.number.toString().padStart(2, '0')}
                            </div>
                            <div class="text-xs font-semibold text-gray-600">${stat.probability.toFixed(2)}%</div>
                            <div class="text-xs text-gray-500 mt-1">${stat.count}x</div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                                <div class="h-1.5 rounded-full ${isTop ? 'bg-gradient-to-r from-orange-500 to-red-500' : 'bg-gray-400'}" 
                                     style="width: ${Math.min(100, stat.probability)}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('allAdditionalNumbers').innerHTML = allAddHTML;
        }

        // Modal functions
        function showAddForm() {
            document.getElementById('addDrawModal').style.display = 'flex';
        }

        function hideAddForm() {
            document.getElementById('addDrawModal').style.display = 'none';
            document.getElementById('addDrawError').style.display = 'none';
        }

        function showFilterForm() {
            document.getElementById('filterModal').style.display = 'flex';
            document.getElementById('filterFromDraw').value = filterSettings.fromDraw;
            document.getElementById('filterToDraw').value = filterSettings.toDraw;
            document.getElementById('filterMonths').value = filterSettings.months;
        }

        function hideFilterForm() {
            document.getElementById('filterModal').style.display = 'none';
        }

        function showImportForm() {
            document.getElementById('importModal').style.display = 'flex';
        }

        function hideImportForm() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importStatus').style.display = 'none';
            document.getElementById('importFileInput').value = '';
        }

        async function handleAddDraw(event) {
            event.preventDefault();
            const errorDiv = document.getElementById('addDrawError');
            
            const drawNumber = document.getElementById('newDrawNumber').value.trim();
            const date = document.getElementById('newDrawDate').value;
            const numbers = [
                parseInt(document.getElementById('newNumber1').value),
                parseInt(document.getElementById('newNumber2').value),
                parseInt(document.getElementById('newNumber3').value),
                parseInt(document.getElementById('newNumber4').value),
                parseInt(document.getElementById('newNumber5').value),
                parseInt(document.getElementById('newNumber6').value)
            ].sort((a, b) => a - b);
            const additional = parseInt(document.getElementById('newAdditional').value);

            // Validate
            if (numbers.some(n => isNaN(n) || n < 1 || n > 49)) {
                errorDiv.textContent = 'All main numbers must be between 1 and 49';
                errorDiv.style.display = 'block';
                return;
            }

            if (new Set(numbers).size !== 6) {
                errorDiv.textContent = 'All main numbers must be unique';
                errorDiv.style.display = 'block';
                return;
            }

            if (isNaN(additional) || additional < 1 || additional > 49) {
                errorDiv.textContent = 'Additional number must be between 1 and 49';
                errorDiv.style.display = 'block';
                return;
            }

            if (historicalData.some(d => d.drawNumber === drawNumber)) {
                errorDiv.textContent = 'Draw number already exists';
                errorDiv.style.display = 'block';
                return;
            }

            historicalData.unshift({ drawNumber, date, numbers, additional });
            historicalData.sort((a, b) => new Date(b.date) - new Date(a.date));
            historicalData = historicalData.slice(0, 312); // Keep last 3 years

            await saveData();
            applyFilters();
            hideAddForm();
            
            // Reset form
            event.target.reset();
        }

        async function handleFileImport() {
            const fileInput = document.getElementById('importFileInput');
            const statusDiv = document.getElementById('importStatus');
            const file = fileInput.files[0];
            
            if (!file) {
                statusDiv.textContent = 'Please select a file';
                statusDiv.className = 'text-sm mb-4 text-red-600';
                statusDiv.style.display = 'block';
                return;
            }

            statusDiv.textContent = 'Reading file...';
            statusDiv.className = 'text-sm mb-4 text-blue-600';
            statusDiv.style.display = 'block';

            try {
                const text = await file.text();
                const rows = text.split('\n').map(row => row.trim()).filter(row => row);
                const dataRows = rows.slice(1); // Skip header
                const importedDraws = [];
                let errorCount = 0;

                for (const row of dataRows) {
                    try {
                        const cols = row.split(',').map(col => col.trim().replace(/^["']|["']$/g, ''));
                        
                        if (cols.length < 8) {
                            errorCount++;
                            continue;
                        }

                        const drawNumber = cols[0];
                        const date = cols[1];
                        const numbers = [
                            parseInt(cols[2]), parseInt(cols[3]), parseInt(cols[4]),
                            parseInt(cols[5]), parseInt(cols[6]), parseInt(cols[7])
                        ].sort((a, b) => a - b);
                        const additional = parseInt(cols[8]);

                        if (!drawNumber || !date || numbers.some(n => isNaN(n) || n < 1 || n > 49) || 
                            isNaN(additional) || additional < 1 || additional > 49 || new Set(numbers).size !== 6) {
                            errorCount++;
                            continue;
                        }

                        importedDraws.push({ drawNumber, date, numbers, additional });
                    } catch (e) {
                        errorCount++;
                    }
                }

                if (importedDraws.length === 0) {
                    statusDiv.textContent = 'Error: No valid data found in file';
                    statusDiv.className = 'text-sm mb-4 text-red-600';
                    return;
                }

                const existingDrawNumbers = new Set(historicalData.map(d => d.drawNumber));
                const newDraws = importedDraws.filter(d => !existingDrawNumbers.has(d.drawNumber));
                
                const combinedDraws = [...newDraws, ...historicalData].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                historicalData = combinedDraws.slice(0, 312);

                await saveData();
                applyFilters();
                
                statusDiv.textContent = `Success! Imported ${newDraws.length} new draws. ${errorCount > 0 ? `Skipped ${errorCount} invalid rows.` : ''}`;
                statusDiv.className = 'text-sm mb-4 text-green-600';
                
                setTimeout(() => {
                    hideImportForm();
                }, 3000);

            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.className = 'text-sm mb-4 text-red-600';
            }
        }

        function downloadTemplate() {
            const template = `DrawNumber,Date,Number1,Number2,Number3,Number4,Number5,Number6,Additional
4128,2025-11-07,5,12,18,25,33,41,22
4127,2025-11-03,10,19,22,34,39,43,35
4126,2025-10-30,1,5,31,34,38,45,15`;

            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'toto-import-template.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportData() {
            let csv = 'DrawNumber,Date,Number1,Number2,Number3,Number4,Number5,Number6,Additional\n';
            
            historicalData.forEach(draw => {
                csv += `${draw.drawNumber},${draw.date},${draw.numbers.join(',')},${draw.additional}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `toto-data-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function refreshData() {
            applyFilters();
        }

        // Handle filter updates
        document.getElementById('filterFromDraw')?.addEventListener('input', (e) => {
            filterSettings.fromDraw = e.target.value;
        });
        document.getElementById('filterToDraw')?.addEventListener('input', (e) => {
            filterSettings.toDraw = e.target.value;
        });
        document.getElementById('filterMonths')?.addEventListener('change', (e) => {
            filterSettings.months = e.target.value;
        });
    </script>
</body>
</html>
